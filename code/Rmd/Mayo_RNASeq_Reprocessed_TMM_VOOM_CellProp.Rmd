---
title: "Markdown to estimate the abundance of brain cell types with the reprocessed counts from Mayo cohorts (with TMM-VOOM normalisation)"
author: "Thanneer Perumal"
date: "`r date()`"
output: html_document
---
```{r knit2synapse, eval=FALSE}
library(synapseClient)
library(knit2synapse)

synapseLogin()

knit2synapse::knitToFolderEntity(file = "./Mayo_RNASeq_Reprocessed_TMM_VOOM_CellProp.Rmd",
                                 parentId = "syn5570325",
                                 entityName = 'MAYO Cell Type Abundance with Reprocessed RNASeq')
```

```{r libs, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE, cache=FALSE}
## It is assumed your working directory is where this file

## Load required libraries
library(CovariateAnalysis) # get it from devtools::install_github('th1vairam/CovariateAnalysis@dev')
library(data.table)
library(tidyr)
library(plyr)
library(dplyr)
library(stringr)

library(ggplot2)
library(reshape2)
library(limma)
library(Biobase)
library(gplots)
library(WGCNA)
library(psych)
library(edgeR)
library(biomaRt)
library(RColorBrewer)
library(xlsx)

library(synapseClient)
library(knitr)
library(githubr)

library(parallel)
library(doParallel)
library(doMC)
library(foreach)

cl = makeCluster(detectCores() - 2)
registerDoParallel(cl)

synapseLogin()

# Source external files
source('../R/CIBERSORT.R')

## Requires ggdendro
devtools::source_url("https://raw.githubusercontent.com/chr1swallace/random-functions/master/R/ggplot-heatmap.R")

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  cache = TRUE)
```

```{r synapse.parameters, include=FALSE, cache=TRUE}
# Synapse parameters
parentId = 'syn5570325';
activityName = 'Cell type abundance in Mayo';
activityDescription = 'Cell type abundance in Mayo with TMM-VOOM normalised reprocessed RNASeq counts';

thisFileName <- 'Mayo_RNASeq_Reprocessed_TMM_VOOM_CellProp.Rmd'

# Github link
thisRepo <- getRepo(repository = "th1vairam/Brain_Reg_Net", ref="branch", refName='celltype')
thisFile <- getPermlink(repository = thisRepo, repositoryPath=paste0('code/Rmd/',thisFileName))
```
### Data download
#### Obtain count matrix and metadata from synapse.
```{r download.data, cache=TRUE}
# Get reprocessed sample counts for temporal cortex
COUNT_TC_ID <- 'syn7987765';
ALL_USED_IDs <- COUNT_TC_ID
COUNT_TC <- read.table(synGet(COUNT_TC_ID)@filePath, header=T, sep='\t', check.names = F)
colnames(COUNT_TC) = paste(colnames(COUNT_TC), 'TCX', sep = '_')

# Get reprocessed sample counts for cerebellum
COUNT_CE_ID <- 'syn7513807';
ALL_USED_IDs[length(ALL_USED_IDs)+1] <- COUNT_CE_ID
COUNT_CE <- read.table(synGet(COUNT_CE_ID)@filePath, header=T, sep='\t', check.names = F)

COUNT = cbind(COUNT_TC, COUNT_CE[rownames(COUNT_TC),])

# Get clinical metadata
METADATA_TC_ID <- 'syn3817650'
ALL_USED_IDs[length(ALL_USED_IDs)+1] = METADATA_TC_ID
METADATA_TC <- read.table(synGet(METADATA_TC_ID)@filePath,sep='\t',header=T, stringsAsFactors=F) %>%
  tidyr::separate(ID, c('Donor_ID', 'BrainRegion'), sep = '_') %>%
  dplyr::mutate(ID = paste(Donor_ID, BrainRegion, sep = '_'))

# Get clinical metadata
METADATA_CE_ID <- 'syn5223705'
ALL_USED_IDs[length(ALL_USED_IDs)+1] = METADATA_CE_ID
METADATA_CE <- read.table(synGet(METADATA_CE_ID)@filePath,sep='\t',header=T, stringsAsFactors=F) %>%
  tidyr::separate(SampleID, c('Donor_ID', 'BrainRegion')) %>%
  dplyr::mutate(ID = paste(Donor_ID, BrainRegion, sep = '_')) %>%
  dplyr::rename(Gender = Sex, FLOWCELL = Flowcell)

METADATA = rbindlist(list(METADATA_TC, METADATA_CE), use.names = T, fill = T) %>%
  as.data.frame
```

### Data preprocessing
```{r preprocess.data,cache=FALSE, echo=TRUE}
# Fix metadata
METADATA$AgeAtDeath = gsub("_or_above", "", METADATA$AgeAtDeath)
METADATA$Diagnosis = gsub("Pathologic Aging","Pathologic_Aging", METADATA$Diagnosis)
METADATA$BrainRegion.Diagnosis = paste(METADATA$BrainRegion, METADATA$Diagnosis, sep = '.')
METADATA$RIN2 = METADATA$RIN^2
METADATA <- METADATA %>%
  filter(!is.na(Source)) %>%
  dplyr::filter(!(ID %in% c("11311_CER", "1923_CER", "1923_TCX", 
                            "11396_TCX", "11294_TCX", "11408_TCX")))
```
Following samples were considered outliers and removed based on PCA and/or eucledian distance: 11311\_CER, 1923\_CER, 1923\_TCX, 11396\_TCX, 11294\_TCX, 11408\_TCX
```{r preprocess.data1}
# Match covariates to expression data
indToRetain = intersect(METADATA$ID, colnames(COUNT))
indRemoved = setdiff(colnames(COUNT), METADATA$ID)

COUNT <- COUNT[, indToRetain]

rownames(METADATA) = METADATA$ID
METADATA = METADATA[indToRetain,]
```
`r dim(COUNT)[2]` samples from `r length(unique(METADATA$Donor_ID))` subjects were obtained from the Mayo cohorts in AMP-AD reprocessed rnaseq project. 

Following samples were removed `r indRemoved`

### Covariate clustering
Determine relationship between covariates. 
```{r covariates.clustering}
FactorCovariates <- c("Donor_ID", "Source", "Gender", "FLOWCELL", "BrainRegion.Diagnosis")
ContCovariates <- c("RIN", "RIN2", "AgeAtDeath","PMI")
  
# Find inter relation between factor covariates
COVARIATES = METADATA[,c(FactorCovariates,ContCovariates),drop=F]
rownames(COVARIATES) <- METADATA$ID

# Convert factor covariates to factors
COVARIATES[,FactorCovariates] = lapply(COVARIATES[,FactorCovariates], factor)
COVARIATES[,ContCovariates] = lapply(COVARIATES[,ContCovariates], as.character)
COVARIATES[,ContCovariates] = lapply(COVARIATES[,ContCovariates], as.numeric)
```
### Gene Filtering
Preprocess counts matrix and metadata. Determine design matrix for normalisation and differential expression analysis. 

Remove genes that have less than 1 cpm counts in at least 50% of samples per BrainRegion.Diagnosis
```{r cpmnormalisation}
genesToAnalyze = COVARIATES %>%
  rownameToFirstColumn('Sampleid') %>%
  dlply(.(BrainRegion.Diagnosis), .fun = function(mtd, count){
    processed.counts = getGeneFilteredGeneExprMatrix(count[,mtd$Sampleid],
                                                     MIN_GENE_CPM=1, 
                                                     MIN_SAMPLE_PERCENT_WITH_MIN_GENE_CPM=0.5)
    processed.counts$filteredExprMatrix$genes
    }, COUNT)
genesToAnalyze = unlist(genesToAnalyze) %>% unique()

PROCESSED_COUNTS = getGeneFilteredGeneExprMatrix(COUNT[genesToAnalyze, ], MIN_GENE_CPM=0, MIN_SAMPLE_PERCENT_WITH_MIN_GENE_CPM=0)
```
Processing `r dim(PROCESSED_COUNTS$filteredExprMatrix)[1]` genes in `r dim(PROCESSED_COUNTS$filteredExprMatrix)[2]` samples
### Normalisation (with NULL)
Initial normalisation usign voom (with NULL design)
```{r initial.voom.normalisation, fig.height=5, fig.width=5}
# TMM normalisation
TMM.GENE_EXPRESSION = calcNormFactors(PROCESSED_COUNTS$filteredExprMatrix, method = 'TMM')

# Initial normalisation of gene expression
VOOM.GENE_EXPRESSION = voom(TMM.GENE_EXPRESSION, design=NULL, plot=T)

# Set gene counts in specific samples that are deviating 3 sd from other samples to NA
log.mat = apply(VOOM.GENE_EXPRESSION$E, 1, function(x){
  mn = mean(x, na.rm = T)
  std.dev = sd(x, na.rm = T)
  return((x < (mn-3*std.dev)) | (x > (mn+3*std.dev)))
}) %>% t
PROCESSED_COUNTS$filteredExprMatrix[log.mat] = NA

# TMM normalisation
TMM.GENE_EXPRESSION = calcNormFactors(PROCESSED_COUNTS$filteredExprMatrix, method = 'TMM')

# Initial normalisation of gene expression
VOOM.GENE_EXPRESSION = voom(TMM.GENE_EXPRESSION, design=NULL, plot=T)
```
### Get cell type specific signatures and expression data from synapse
```{r get.signatures}
ALL_USED_IDs = c(ALL_USED_IDs, 'syn8068511', 'syn8068475')
# Signatures from Zhang,Y et al., 2014
sig.zhang = downloadFile('syn8068511') %>%
  dlply(.(Set), .fun = function(x){return(unique(x$Gene))})

# Signatures from Darmanis, S et al., 2015
sig.dar.obj = synGet('syn8068475')  
sig.dar.unbiased = read.xlsx(sig.dar.obj@filePath, sheetName = 'Unbiased') %>%
  lapply(function(x){as.character(unique(x))})
sig.dar.unbiased = sig.dar.unbiased[1:10]

# Extract all signatures
sig = list()
sig$OPC = unique(c(sig.zhang$OPC, sig.dar.unbiased$Cluster.1))
sig$Oligodendrocyte = unique(c(sig.zhang$MyelinOligos, sig.zhang$NewOligos, sig.dar.unbiased$Cluster.3))
sig$Neuron = unique(c(sig.zhang$Neuron, sig.dar.unbiased$Cluster.6, sig.dar.unbiased$Cluster.7,
                      sig.dar.unbiased$Cluster.10, sig.dar.unbiased$Cluster.2))
sig$Endothelial = unique(c(sig.zhang$Endothelial, sig.dar.unbiased$Cluster.8))
sig$Astrocyte = unique(c(sig.zhang$Astrocyte, sig.dar.unbiased$Cluster.4))
sig$Microglia = unique(c(sig.zhang$Astrocyte, sig.dar.unbiased$Cluster.5))

sig = ldply(sig, .fun = function(x){as.data.frame(x)})
colnames(sig) = c('CellType','Gene.Name')

# Get reference expression data from Darmanis., S et al., 2015
ALL_USED_IDs = c(ALL_USED_IDs, 'syn8077142', 'syn8077191')
ref.expr = downloadFile('syn8077142')
rownames(ref.expr) = ref.expr$hgnc_symbol
ref.expr$hgnc_symbol = NULL

ref.cellTypes = downloadFile('syn8077191') %>%
  dplyr::select(SampleID, CellType)

ref.expr1 = list()
for(celltype in unique(ref.cellTypes$CellType)){
  ids = ref.cellTypes$SampleID[ref.cellTypes$CellType == celltype]
  ref.expr1[[celltype]] = log2(rowSums(2^ref.expr[,ids], na.rm = T)) %>%
    rownameToFirstColumn('hgnc_symbol') %>%
    plyr::rename(c('DF' = celltype))
}
ref.expr1 = join_all(ref.expr1)
```

```{r get.gene.symbols, include=FALSE}
backgroundGenes = data.frame(gene.id = rownames(VOOM.GENE_EXPRESSION$E)) %>%
  dplyr::mutate(ensembl_gene_id = gene.id) %>%
  tidyr::separate(ensembl_gene_id, c('ensembl_gene_id', 'position'), sep = '\\.')

# Define biomart object
mart <- useMart(biomart = "ENSEMBL_MART_ENSEMBL", host = "mar2016.archive.ensembl.org", dataset = "hsapiens_gene_ensembl")

# Query biomart
Ensemble2HGNC <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol"),
                       filters = "ensembl_gene_id", 
                       values = backgroundGenes$ensembl_gene_id,
                       mart = mart)

# Add gene names
EXPR <- VOOM.GENE_EXPRESSION$E %>%
  rownameToFirstColumn('gene.id') %>%
  left_join(backgroundGenes) %>%
  left_join(Ensemble2HGNC) %>%
  filter(!duplicated(gene.id))
rownames(EXPR) = EXPR$gene.id

EXPR1 = WGCNA::collapseRows(EXPR %>% dplyr::select(-ensembl_gene_id, -position, -hgnc_symbol, -gene.id), 
                            EXPR$hgnc_symbol, 
                            EXPR$gene.id)$datETcollapsed

ind = intersect(rownames(EXPR1), ref.expr1$hgnc_symbol)
EXPR1 = EXPR1 %>% 
  rownameToFirstColumn('hgnc_symbol') %>%
  filter(hgnc_symbol %in% ind)
ref.expr1 = ref.expr1 %>%
  filter(hgnc_symbol %in% ind)

write.table(ref.expr1, file = 'ref.expr.txt', sep = '\t', quote=F, row.names = F)
write.table(EXPR1, file = 'mixture.expr.txt', sep = '\t', quote=F, row.names = F)

cellprop = CIBERSORT('ref.expr.txt', 'mixture.expr.txt', perm = 100) # Obtain CIBERSORT.R function from http://cibersort.stanford.edu/
stopCluster(cl)
```

```{r plot.cellprop}
cellprop1 = as.data.frame(cellprop)
cellprop1$BrainRegion.Diagnosis = COVARIATES[rownames(cellprop), 'BrainRegion.Diagnosis']
cellprop1 = cellprop1 %>% 
  rownameToFirstColumn('SampleID') %>%
  dplyr::select(-`P-value`,-Correlation, -RMSE) %>%
  tidyr::gather(Celltype, Fraction, -SampleID, -BrainRegion.Diagnosis) %>%
  dplyr::arrange(desc(BrainRegion.Diagnosis))

p = ggplot(cellprop1, aes(x = SampleID, y = Fraction, fill = Celltype, color = BrainRegion.Diagnosis)) + geom_bar(stat = 'identity')
p = p + theme(axis.text.x = element_text(angle = 90, hjust = 1))
# p = p + facet_grid(.~BrainRegion.Diagnosis)
# p

p = ggplot(cellprop1, aes(x = Celltype, y = Fraction, color = BrainRegion.Diagnosis)) + geom_boxplot()
p = p + theme(axis.text.x = element_text(angle = 90, hjust = 1))
p
```
### Synapse store
```{r syn.store, cache=TRUE}
CODE = Folder(name = 'MAYO Cell Type Abundance with Reprocessed RNASeq', parentId = parentId)
CODE = synStore(CODE)

cellprop %>%
  rownameToFirstColumn('SampleID') %>%
  write.table(file = 'MAYO_CellFraction_Reproc.tsv', row.names = F, sep = '\t', quote = F)
obj = File('MAYO_CellFraction_Reproc.tsv', name = 'MAYO Cell Fraction', parentId = CODE$properties$id)
obj = synStore(obj, activityName = activityName, activityDescription = activityDescription,
               used = ALL_USED_IDs, executed = thisFile)
```