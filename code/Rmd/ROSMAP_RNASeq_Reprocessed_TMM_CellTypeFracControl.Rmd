---
title: "Covariate analysis of ROSMAP reprocessed counts with controlled cell type variation (with TMM normalisation)"
author: "Thanneer Perumal"
date: "`r date()`"
output: html_document
---
```{r knit2synapse, eval=FALSE}
library(synapseClient)
library(knit2synapse)

synapseLogin()

knit2synapse::knitToFolderEntity(file = "./ROSMAP_RNASeq_Reprocessed_TMM_CellTypeFracControl.Rmd",
                                 parentId = "syn5570291",
                                 entityName = 'ROSMAP Reprocessed RNASeq TMM WithCellTypeFractionControlled (Based on cogdx)')
```

```{r libs, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
## It is assumed your working directory is where this file

## Load required libraries
library(CovariateAnalysis) # get it from devtools::install_github('th1vairam/CovariateAnalysis@dev')
library(data.table)
library(tidyr)
library(plyr)
library(dplyr)
library(stringr)

library(ggplot2)
library(reshape2)
library(limma)
library(Biobase)
library(gplots)
library(WGCNA)
library(psych)
library(edgeR)
library(biomaRt)
library(RColorBrewer)

library(synapseClient)
library(knitr)
library(githubr)

synapseLogin()

## Requires ggdendro
devtools::source_url("https://raw.githubusercontent.com/chr1swallace/random-functions/master/R/ggplot-heatmap.R")

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  cache = TRUE)
```

```{r synapse.parameters, include=FALSE, cache=TRUE}
# Synapse parameters
parentId = 'syn5570291';
activityName = 'Covariate analysis with celltype controlled';
activityDescription = 'Covariate analysis of ROSMAP reprocessed RNASeq data';

thisFileName <- 'ROSMAP_RNASeq_Reprocessed_TMM_CellTypeFracControl.Rmd'

# Github link
thisRepo <- getRepo(repository = "th1vairam/Brain_Reg_Net", ref="branch", refName='AMPAD')
thisFile <- getPermlink(repository = thisRepo, repositoryPath=paste0('code/Rmd/',thisFileName))
```
### Data download
#### Obtain count matrix and metadata from synapse.
```{r download.data, cache=TRUE}
# Download expression data
COUNT_ID <- 'syn7750270';
ALL_USED_IDs <- COUNT_ID
COUNT_OBJ <- synGet(COUNT_ID)
COUNT <- read.table(COUNT_OBJ@filePath,header=T,sep='\t',check.names = F)

# Get clinical metadata
METADATA.CLINICAL_ID <- 'syn3191087'
ALL_USED_IDs[length(ALL_USED_IDs)+1] = METADATA.CLINICAL_ID
METADATA.CLINICAL_OBJ <- synGet(METADATA.CLINICAL_ID)
METADATA.CLINICAL <- read.table(METADATA.CLINICAL_OBJ@filePath,sep=',',header=T)

# Get technical covariates
METADATA.TECH_ID <- 'syn4300313'
ALL_USED_IDs[length(ALL_USED_IDs)+1] = METADATA.TECH_ID
METADATA.TECH_OBJ <- synGet(METADATA.TECH_ID)
METADATA.TECH <- read.table(METADATA.TECH_OBJ@filePath,sep='\t',header=T)

# Fix error in technical covariates data
KEY_ID <- 'syn3382527'
ALL_USED_IDs[length(ALL_USED_IDs)+1] = KEY_ID  
KEY <- read.csv(synGet(KEY_ID)@filePath) %>% 
  filter(mrna_data == 1) %>%
  dplyr::select(projid, mrna_id) %>%
  separate(mrna_id, c('a','b','batch'), sep = '_') %>% 
  unite(Sampleid, a, b) %>%
  dplyr::select(-batch) %>%
  unique

# Match technical and clinical covariates
METADATA <- METADATA.TECH %>% 
  dplyr::select(-projid) %>%
  dplyr::left_join(KEY) %>%
  dplyr::left_join(METADATA.CLINICAL)

# Pick higher quality RIN batch for sample 492_120515
METADATA <- METADATA %>%
  group_by(Sampleid) %>%
  top_n(1, RINcontinuous)

# Get deconvoluted cell type fractions of ROSMAP samples from synapse 
CELL_TYPE_FRAC = downloadFile('syn8124520') %>%
  dplyr::select(-OPC, -`P-value`, -Correlation, -RMSE)
rownames(CELL_TYPE_FRAC) = CELL_TYPE_FRAC$SampleID
CELL_TYPE_FRAC$SampleID = NULL
CELL_TYPE_FRAC = data.matrix(CELL_TYPE_FRAC)
```

### Data preprocessing
```{r preprocess.data,cache=TRUE, echo=TRUE}
# Remove samples with no cogdx, RIN and PMI scores
METADATA <- METADATA %>%
  ungroup %>%
  filter(Sampleid %in% colnames(COUNT)) %>%
  filter(!is.na(cogdx)) %>%
  filter(!is.na(RINcontinuous)) %>%
  filter(!is.na(pmi)) %>%
  filter(!is.na(Sampleid)) %>%
  filter(!(Sampleid %in% c('380_120503'))) %>%
  as.data.frame()
```

```{r preprocess.data1,cache=TRUE}
# Match covariates to expression data
indToRetain = intersect(METADATA$Sampleid, colnames(COUNT))
removedIDs = setdiff(colnames(COUNT), METADATA$Sampleid)

COUNT = COUNT[,indToRetain]

rownames(METADATA) = METADATA$Sampleid
METADATA = METADATA[indToRetain,]

CELL_TYPE_FRAC = CELL_TYPE_FRAC[indToRetain,]
```
Dorsolateral prefrontal cortex of `r dim(COUNT)[2]` subjects from the ROS and MAP cohorts are used for the analysis. Following sample are removed `r paste(removedIDs, collapse = ',')`

### Covariate clustering
Determine relationship between covariates. 
```{r covariates.clustering, cache=TRUE}
#"braaksc","ceradsc","cts_mmse30_first_ad_dx","cts_mmse30_lv"
FactorCovariates <- c("Batch", "msex", "race", "spanish", "cogdx")
ContCovariates <- c("RINcontinuous","age_first_ad_dx","age_death","age_at_visit_max","pmi","educ")
  
# Find inter relation between factor covariates
COVARIATES = METADATA[,c(FactorCovariates,ContCovariates),drop=F]
COVARIATES <- data.frame(lapply(COVARIATES,function(x){x <- sapply(x,function(y){str_replace_all(as.character(y),'\\+','')})}))
rownames(COVARIATES) <- METADATA$Sampleid

# Convert factor covariates to factors
COVARIATES[,FactorCovariates] = lapply(COVARIATES[,FactorCovariates], factor)
COVARIATES[,ContCovariates] = lapply(COVARIATES[,ContCovariates], as.character)
COVARIATES[,ContCovariates] = lapply(COVARIATES[,ContCovariates], as.numeric)

# Add in RIN^2 values
COVARIATES$RINcontinuous2 = COVARIATES$RINcontinuous^2
ContCovariates = c(ContCovariates, 'RINcontinuous2')

# Add cell type fractions to the covariates
COVARIATES = cbind(COVARIATES, CELL_TYPE_FRAC[rownames(COVARIATES),])
```
Correlation/association between covariates at an FDR <= 0.1
```{r covariates.correlation, fig.width=10, fig.height=10}
COVARIATES.CORRELATION = getAssociationStatistics(COVARIATES, PVAL = 0.05)
ggheatmap.show(COVARIATES.CORRELATION$plot, col.width=0.5, row.width=0.1)
```

```{r dataExplore, fig.width = 10, fig.height = 10}
# RIN
p = list()
p[[1]] = ggplot(COVARIATES, aes(x = cogdx, y = RINcontinuous)) + geom_boxplot()
p[[1]] = p[[1]] + ggtitle('RIN') + theme(legend.position = 'top')

# AgeAtDeath
p[[2]] = ggplot(COVARIATES, aes(x = cogdx, y = age_death)) + geom_boxplot()
p[[2]] = p[[2]] + ggtitle('AgeOfDeath') + theme(legend.position = 'top')

# PMI
p[[3]] = ggplot(COVARIATES, aes(x = cogdx, y = pmi)) + geom_boxplot()
p[[3]] = p[[3]] + ggtitle('PMI') + theme(legend.position = 'top')

# Education
p[[4]] = ggplot(COVARIATES, aes(x = cogdx, y = educ)) + geom_boxplot()
p[[4]] = p[[4]] + ggtitle('Education') + theme(legend.position = 'top')

multiplot(plotlist = p, cols = 2)

# Cell type fractions
p = CELL_TYPE_FRAC %>%
  rownameToFirstColumn('SampleID') %>%
  left_join(COVARIATES %>%
              rownameToFirstColumn('SampleID') %>%
              dplyr::select(cogdx, SampleID)) %>%
  tidyr::gather(CellType, Fraction, -SampleID, -cogdx) %>%
  ggplot(aes(x = cogdx, y = Fraction, color = CellType))
p = p + geom_boxplot()
p

# Batch
vcd::mosaic(~ Batch + cogdx, data = COVARIATES)

# Sex
vcd::mosaic(~ msex + cogdx, data = COVARIATES)
```
### CPM Normalisation
Preprocess counts matrix and metadata. Determine design matrix for normalisation and differential expression analysis. 

Remove genes that have less than 1 cpm counts in at least 50% of samples per cogdx
```{r cpmnormalisation}
genesToAnalyze = COVARIATES %>%
  rownameToFirstColumn('Sampleid') %>%
  dlply(.(cogdx), .fun = function(mtd, count){
  processed.counts = getGeneFilteredGeneExprMatrix(count[,mtd$Sampleid],
                                                   MIN_GENE_CPM=1, 
                                                   MIN_SAMPLE_PERCENT_WITH_MIN_GENE_CPM=0.5)
  processed.counts$filteredExprMatrix$genes
}, COUNT)
genesToAnalyze = unlist(genesToAnalyze) %>% unique()

PROCESSED_COUNTS = getGeneFilteredGeneExprMatrix(COUNT[genesToAnalyze, ], MIN_GENE_CPM=0, MIN_SAMPLE_PERCENT_WITH_MIN_GENE_CPM=0)
```
Processing `r dim(PROCESSED_COUNTS$filteredExprMatrix)[1]` genes in `r dim(PROCESSED_COUNTS$filteredExprMatrix)[2]` samples

### Normalisation (with NULL)
Initial normalisation usign voom (with NULL design)
```{r initial.voom.normalisation, fig.height=5, fig.width=5}
# TMM normalisation
TMM.GENE_EXPRESSION = calcNormFactors(PROCESSED_COUNTS$filteredExprMatrix, method = 'TMM')

# Initial normalisation of gene expression
VOOM.GENE_EXPRESSION = voom(TMM.GENE_EXPRESSION, design=NULL, plot=T)

# Set gene counts in specific samples that are deviating 3 sd from other samples to NA
log.mat = apply(VOOM.GENE_EXPRESSION$E, 1, function(x){
  mn = mean(x, na.rm = T)
  std.dev = sd(x, na.rm = T)
  return((x < (mn-3*std.dev)) | (x > (mn+3*std.dev)))
}) %>% t
PROCESSED_COUNTS$filteredExprMatrix[log.mat] = NA

# TMM normalisation
TMM.GENE_EXPRESSION = calcNormFactors(PROCESSED_COUNTS$filteredExprMatrix, method = 'TMM')

# Initial normalisation of gene expression
VOOM.GENE_EXPRESSION = voom(TMM.GENE_EXPRESSION, design=NULL, plot=T)
```
Coexpression of genes 
```{r coexp1, cache=FALSE, fig.height=5, fig.width=5}
cr = cor(t(VOOM.GENE_EXPRESSION$E))
hist(cr, main = 'Distribution of correlation between genes', xlab = 'Correlation')
```
### Outlier analysis
Clustering of voom adjusted data (with NULL design)
```{r decompse.normalise.data, fig.height=5, fig.width=8, results='asis'}
# Find principal components of expression to plot
PC <- prcomp(VOOM.GENE_EXPRESSION$E, scale.=T, center = T)

# Plot first 2 PCs
plotdata <- data.frame(SampleID=rownames(PC$rotation), 
                       PC1=PC$rotation[,1], 
                       PC2=PC$rotation[,2])

plotdata <- left_join(plotdata, rownameToFirstColumn(COVARIATES, 'SampleID'))

p <- ggplot(plotdata, aes(x=PC1, y=PC2))
p <- p + geom_point(aes(color=Batch, shape=cogdx, size=RINcontinuous))
p <- p + theme_bw() + theme(legend.position="right")
# p <- p + geom_text(aes(label= SampleID), size=4, hjust=0)
p
```
Tree based classification of samples
```{r decompse.normalise.data.1, fig.height=6, fig.width=10, results='asis'}
# Eucledian tree based analysis
COVARIATES.tmp = data.matrix(COVARIATES[,c('Batch', 'msex', 'cogdx')])
COVARIATES.tmp[is.na(COVARIATES.tmp)] = 0

tree = hclust(as.dist(t(VOOM.GENE_EXPRESSION$E)))
cols = WGCNA::labels2colors(COVARIATES.tmp);

WGCNA::plotDendroAndColors(tree, 
                           colors = cols, 
                           dendroLabels = FALSE, 
                           abHeight = 0.80, 
                           main = "Sample dendrogram",
                           groupLabels = colnames(COVARIATES.tmp[,c('Batch', 'msex', 'cogdx')]))
```

```{r temp, include = F}
dev.off()
gc()
```

### Significant Covariates
Correlation between pca of unadjusted mRNA expression and covariates is used to find significant covariates
```{r preAdjusted.covariates, cache=TRUE}
# Find correlation between PC's of gene expression with covariates
preAdjustedSigCovars = runPCAandPlotCorrelations(VOOM.GENE_EXPRESSION$E, 
                                                 COVARIATES,
                                                 'NULL design(voom-normalized)', 
                                                 isKeyPlot=TRUE, 
                                                 MIN_PVE_PCT_PC = 1)
```

Significant covariates to adjust at FDR 0.1 are `r preAdjustedSigCovars$significantCovars`
```{r preAdjustedSigCovars.NULL, fig.width=20, fig.height=12}
preAdjustedSigCovars[["PC_res"]][[2]]$plotData
```
### Normalisation (custom design)
Since many covariates are correlated, re-normalising COUNTS with an custom design matrix. Here "cogdx" times cell type fractions are chosen as the primary variables of interest (i.e., covariate selection is conditioned on cognitive scores times cell type proportion)

Final model:
    Gx = Batch + msex + RINcontinuous + pmi + age_death + cogdx.oligodendrocytes + cogdx.astrocytes + cogdx.microglia + cogdx.neurons + cogdx.endothelial
```{r customNorm, results='asis'}
# Covariates of interest
postAdjustCovars = c('cogdx', 'Batch', 'msex', 'RINcontinuous', 'pmi', 'age_death');

# Post adjusted design matrix
DESIGN.MATRIX = getDesignMatrix(COVARIATES[,postAdjustCovars,drop=F],Intercept = F)$design

ind.design = grep('cogdx', colnames(DESIGN.MATRIX), value = T)
ind.celltypes = colnames(CELL_TYPE_FRAC)
for(i in ind.celltypes){
  for(j in ind.design){
    tmp = DESIGN.MATRIX[, j, drop = F] * COVARIATES[,i, drop = F]
    colnames(tmp) = paste0(j,'.',i)
    DESIGN.MATRIX = cbind(tmp, DESIGN.MATRIX)
  }
}
DESIGN.MATRIX = DESIGN.MATRIX[, setdiff(colnames(DESIGN.MATRIX), ind.design)]
DESIGN.MATRIX = DESIGN.MATRIX[,linColumnFinder(DESIGN.MATRIX)$indepCols]

writeLines(paste('Using following covariates in the model:',
                 paste(colnames(DESIGN.MATRIX), collapse=', '),
                 'as fixed effects'))

# Estimate voom weights
VOOM.ADJUSTED.GENE_EXPRESSION = voom(TMM.GENE_EXPRESSION, design=DESIGN.MATRIX, plot=F)

# Fit linear model using new weights and new design
VOOM.ADJUSTED.FIT = lmFit(VOOM.ADJUSTED.GENE_EXPRESSION)

# Residuals after normalisation
RESIDUAL.GENE_EXPRESSION = residuals.MArrayLM(VOOM.ADJUSTED.FIT,VOOM.ADJUSTED.GENE_EXPRESSION$E)

# Find PC of residual gene expression and significant covariates that are highly correlated with PCs
residualSigCovars = runPCAandPlotCorrelations(RESIDUAL.GENE_EXPRESSION, 
                                              COVARIATES, 
                                              'adjusted design(voom-normalized)',
                                              isKeyPlot=TRUE)
```

### Sanity check
```{r residualSigCovars.manual, fig.width=12, fig.height=8}
residualSigCovars[["PC_res"]][[2]]$plotData
```

### Residual calculation
Calculate weighted residuals and add back "cogdx.celltypes" to the residuals
```{r varsToAddBack}
# Add variable of interest back to the residuals
varsToAddIn = grep("cogdx", colnames(DESIGN.MATRIX), value = T)
RESIDUAL.GENE_EXPRESSION = RESIDUAL.GENE_EXPRESSION + 
  VOOM.ADJUSTED.FIT$coefficients[,varsToAddIn] %*% t(VOOM.ADJUSTED.FIT$design[,varsToAddIn])
```
Coexpression of genes 
```{r coexp2, cache=FALSE, fig.height=5, fig.width=5}
cr = cor(t(RESIDUAL.GENE_EXPRESSION))
hist(cr, main = 'Distribution of correlation between genes', xlab = 'Correlation')
```

### Clustering residual data
```{r decompse.normalise.data2, fig.height=8, fig.width=8, results='asis'}
# Find principal components of expression to plot
PC <- prcomp(RESIDUAL.GENE_EXPRESSION, scale.=T, center = T)

# Plot first 4 PCs
plotdata <- data.frame(SampleID=rownames(PC$rotation), 
                       PC1=PC$rotation[,1], 
                       PC2=PC$rotation[,2])

plotdata <- left_join(plotdata, rownameToFirstColumn(COVARIATES, 'SampleID'))

p <- ggplot(plotdata, aes(x=PC1, y=PC2)) 
p <- p + geom_point(aes(color=Batch, shape=cogdx, size=RINcontinuous))
p <- p + theme_bw() + theme(legend.position="right")
# p <- p + geom_text(aes(label= SampleID), size=4, hjust=1)
p
```

```{r decompse.normalise.data2.1, fig.height=8, fig.width=12, results='asis'}
# Eucledian tree based analysis
COVARIATES.tmp = data.matrix(COVARIATES[,c('Batch', 'msex', 'cogdx')])
COVARIATES.tmp[is.na(COVARIATES.tmp)] = 0

tree = hclust(as.dist(t(VOOM.GENE_EXPRESSION$E)))
cols = WGCNA::labels2colors(COVARIATES.tmp);

WGCNA::plotDendroAndColors(tree, 
                           colors = cols, 
                           dendroLabels = FALSE, 
                           abHeight = 0.80, 
                           main = "Sample dendrogram",
                           groupLabels = colnames(COVARIATES.tmp))
```

```{r temp1, include=F}
dev.off()
gc()
```

```{r get.gene.symbols, cache=TRUE, eval=T}
backgroundGenes = data.frame(gene.id = rownames(COUNT)) %>%
  dplyr::mutate(ensembl_gene_id = gene.id) %>%
  tidyr::separate(ensembl_gene_id, c('ensembl_gene_id', 'position'), sep = '\\.')

# Define biomart object
mart <- useMart(biomart = "ENSEMBL_MART_ENSEMBL", host = "dec2016.archive.ensembl.org", dataset = "hsapiens_gene_ensembl")

# Query biomart
Ensemble2HGNC <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol"),
                       filters = "ensembl_gene_id", 
                       values = backgroundGenes$ensembl_gene_id,
                       mart = mart)

# Add gene names
RESIDUAL.GENE_EXPRESSION <- RESIDUAL.GENE_EXPRESSION %>%
  rownameToFirstColumn('gene.id') %>%
  left_join(backgroundGenes) %>%
  left_join(Ensemble2HGNC) %>%
  dplyr::select(gene.id, ensembl_gene_id, hgnc_symbol, one_of(rownames(COVARIATES)))

VOOM.ADJUSTED.GENE_EXPRESSION$E <- VOOM.ADJUSTED.GENE_EXPRESSION$E %>%
  rownameToFirstColumn('gene.id') %>%
  left_join(backgroundGenes) %>%
  left_join(Ensemble2HGNC) %>%
  dplyr::select(gene.id, ensembl_gene_id, hgnc_symbol, one_of(rownames(COVARIATES)))
```

Interpretation of cogdx scores

1. NCI, No cognitive impairment (No impaired domains)
2. MCI, Mild cognitive impairment (One impaired domain) and NO other cause of CI
3. MCI, Mild cognitive impairment (One impaired domain) AND another cause of CI
4. AD, Alzheimer's disease and NO other cause of CI (NINCDS PROB AD)
5. AD, Alzheimer's disease AND another cause of CI (NINCDS POSS AD)
6. Other dementia. Other primary cause of dementia

### Differential expression analysis
Genes that are differentially expressed at an FDR <= 0.05 are
```{r diffExp, fig.height=6, fig.width=18}
# Fit contrast
contrast = makeContrasts(contrasts=c("cogdx1.oligodendrocytes-cogdx2.oligodendrocytes",
                                     "cogdx1.oligodendrocytes-cogdx4.oligodendrocytes",
                                     "cogdx2.oligodendrocytes-cogdx4.oligodendrocytes",
                                     "cogdx1.astrocytes-cogdx2.astrocytes",
                                     "cogdx1.astrocytes-cogdx4.astrocytes",
                                     "cogdx2.astrocytes-cogdx4.astrocytes",
                                     "cogdx1.microglia-cogdx2.microglia",
                                     "cogdx1.microglia-cogdx4.microglia",
                                     "cogdx2.microglia-cogdx4.microglia",
                                     "cogdx1.neurons-cogdx2.neurons",
                                     "cogdx1.neurons-cogdx4.neurons",
                                     "cogdx2.neurons-cogdx4.neurons",
                                     "cogdx1.endothelial-cogdx2.endothelial",
                                     "cogdx1.endothelial-cogdx4.endothelial",
                                     "cogdx2.endothelial-cogdx4.endothelial"),
                         levels = colnames(VOOM.ADJUSTED.FIT$coefficients))
FIT.CONTR = contrasts.fit(VOOM.ADJUSTED.FIT, contrasts=contrast)
FIT.CONTR = eBayes(FIT.CONTR)

# Get differnetial expression
DE = lapply(1:dim(contrast)[2], function(i, FIT, VOOM.ADJUSTED.GENE_EXPRESSION, Ensemble2HGNC){
  topTable(FIT.CONTR, coef=i, number = dim(VOOM.ADJUSTED.GENE_EXPRESSION$E)[1], confint = T,
           adjust.method = 'BH') %>%
    rownameToFirstColumn('gene.id') %>%
    left_join(backgroundGenes) %>%
    left_join(Ensemble2HGNC) %>%
    dplyr::select(gene.id, ensembl_gene_id, hgnc_symbol, logFC, CI.L, CI.R, AveExpr, t, P.Value, adj.P.Val, B)
}, FIT, VOOM.ADJUSTED.GENE_EXPRESSION, Ensemble2HGNC) 
names(DE) = colnames(contrast)

DE1 = DE %>% 
  rbindlist(idcol = 'Comparison') %>%
  tidyr::separate(Comparison, c('c1','c2'), sep = '-') %>%
  tidyr::separate(c1, c('cond1', 'celltype'), sep = '\\.') %>%
  tidyr::separate(c2, c('cond2', 'celltype2'), sep = '\\.') %>%
  tidyr::unite(Comparison, cond1, cond2, sep = '_vs_') %>%
  dplyr::select(-celltype2) %>%
  dplyr::mutate(Study = 'ROSMAP', Region = 'DLPFC',
                Direction = logFC/abs(logFC),
                Direction = factor(Direction, c(-1,1), c('-1' = 'DOWN', '1' = 'UP')))
DE1$Direction = as.character(DE1$Direction)
DE1$Direction[DE1$logFC < log2(1.2) & DE1$adj.P.Val > 0.05] = 'NONE'
DE1$Direction[DE1$logFC > -log2(1.2) & DE1$adj.P.Val > 0.05] = 'NONE'
DE1$Direction = factor(DE1$Direction, levels = c('DOWN','NONE','UP'))

writeLines('Number of differentially expressed genes at an FDR of 0.05')
DE1 %>%
  dplyr::filter(adj.P.Val <= 0.05) %>%
  dplyr::select(gene.id, Comparison, celltype, Direction) %>%
  group_by(Comparison, celltype, Direction) %>%
  dplyr::summarise(FDR_0_05 = length(unique(gene.id))) %>%
  tidyr::unite('celltype.direction', celltype, Direction, sep = '.') %>%
  spread(celltype.direction, FDR_0_05) %>%
  kable

writeLines('Number of differentially expressed genes at an FDR of 0.05 and fold change of 1.2')
DE1 %>%
  dplyr::filter(adj.P.Val <= 0.05, abs(logFC) >= log2(1.2)) %>%
  dplyr::select(gene.id, Comparison, celltype, Direction) %>%
  group_by(Comparison, celltype, Direction) %>%
  dplyr::summarise(FDR_0_05 = length(unique(gene.id))) %>%
  tidyr::unite('celltype.direction', celltype, Direction, sep = '.') %>%
  spread(celltype.direction, FDR_0_05) %>%
  kable

p = ggplot(DE1 %>% filter(Comparison != 'cogdx1_vs_cogdx2'), aes(y = -log10(adj.P.Val), x = logFC, color = Direction)) + geom_point()
p = p + scale_color_manual(values = c('green','grey','red'))
p = p + geom_hline(yintercept = -log10(0.05), color = 'red') 
p = p + geom_vline(xintercept = log2(1.2), color = 'red') 
p = p + geom_vline(xintercept = -log2(1.2), color = 'red') 
p = p + facet_grid(Comparison~.+celltype, scales = 'free_x')
p
```

### Store files in synapse
```{r synapse.store, include=FALSE, eval=TRUE, cache=FALSE}
# Code
CODE <- Folder(name = "ROSMAP Reprocessed RNASeq TMM WithCellTypeFractionControlled (Based on cogdx)", parentId = parentId)
annotations(CODE) = list(
  dataType = 'mRNA',
  dataSubType = 'geneExp',
  summaryLevel = 'gene',
  assay	 = 'Reprocessed RNAseq',
  
  tissueTypeAbrv	= 'DLPFC', 
  study = 'ROSMAP', 
  center = 'BROAD-RUSH',
  
  organism = 'HomoSapiens',
  consortium	= 'AMP-AD',
   
  normalizationStatus	= TRUE,
  modelSystem	= FALSE,
  
  normalizationType	= 'TMM and CellType'
)
CODE <- synStore(CODE)

# Store covariates
COVARIATES = rownameToFirstColumn(COVARIATES, 'Sampleid')
write.table(COVARIATES, file = 'ROSMAP_DLPFC_Covariates.tsv', sep = '\t', row.names=F, quote=F)
COV_OBJ = File('ROSMAP_DLPFC_Covariates.tsv', name = 'Covariates', parentId = CODE$properties$id)
COV_OBJ = synStore(COV_OBJ, used = ALL_USED_IDs, activityName = activityName, 
                   executed = thisFile, activityDescription = activityDescription)

# Store filtered counts
PROCESSED_COUNTS$filteredExprMatrix %>%
  as.matrix() %>% rownameToFirstColumn('gene.id') %>%
  write.table(file = 'ROSMAP_DLPFC_Counts.tsv', sep = '\t', row.names=F, quote=F)
COUNT_OBJ = File('ROSMAP_DLPFC_Counts.tsv', name = 'Raw counts (filtered)', parentId = CODE$properties$id)
COUNT_OBJ = synStore(COUNT_OBJ, used = ALL_USED_IDs, activityName = activityName, 
                     executed = thisFile, activityDescription = activityDescription)

# Store logCPM
write.table(VOOM.ADJUSTED.GENE_EXPRESSION$E, file = 'ROSMAP_DLPFC_logCPM.tsv', sep = '\t', row.names=F, quote=F)
LCOUNT_OBJ = File('ROSMAP_DLPFC_logCPM.tsv', name = 'Raw counts (logCPM)', parentId = CODE$properties$id)
LCOUNT_OBJ = synStore(LCOUNT_OBJ, used = ALL_USED_IDs, activityName = activityName, 
                      executed = thisFile, activityDescription = activityDescription)

# Store design matrix
write.table(DESIGN.MATRIX, file = 'ROSMAP_DLPFC_Design.tsv', sep = '\t', row.names=F, quote=F)
DM_OBJ = File('ROSMAP_DLPFC_Design.tsv', name = 'Design Matrix', parentId = CODE$properties$id)
DM_OBJ = synStore(DM_OBJ, used = ALL_USED_IDs, activityName = activityName, 
                  executed = thisFile, activityDescription = activityDescription)

# Store residual gene expression
write.table(RESIDUAL.GENE_EXPRESSION, file = 'ROSMAP_DLPFC_Expression.tsv', sep = '\t', row.names=F, quote=F)
EXP_OBJ = File('ROSMAP_DLPFC_Expression.tsv', name = 'Normalised Adjusted Residual Expression (Dx added)', parentId = CODE$properties$id)
EXP_OBJ = synStore(EXP_OBJ, used = ALL_USED_IDs, activityName = activityName, 
                   executed = thisFile, activityDescription = activityDescription)

# Store differential expression results
write.table(DE1, file = 'ROSMAP_DLPFC_DiffExpression.tsv', sep = '\t', row.names=F, quote=F)
DEXP_OBJ = File('ROSMAP_DLPFC_DiffExpression.tsv', name = 'Differential Expression Analysis', parentId = CODE$properties$id)
DEXP_OBJ = synStore(DEXP_OBJ, used = ALL_USED_IDs, activityName = activityName, 
                    executed = thisFile, activityDescription = activityDescription)
```
|  *Results*                |  *SynapseID*                     |
|  -------                  |   ---------                      |
|  Covariates               |  `r COV_OBJ$properties$id`       |
|  Raw counts (log CPM)     |  `r COUNT_OBJ$properties$id`     |
|  Design Matrix            |  `r DM_OBJ$properties$id`        |
|  Residual Expression      |  `r EXP_OBJ$properties$id`       |
|  Differential Expression  |  `r DEXP_OBJ$properties$id`      |